#!/usr/bin/with-contenv bash

while [ ! -S /run/nordvpn/nordvpnd.sock ] ; do
  sleep 1
done

[[ -z "${TOKEN}" ]] && [[ -f "${TOKENFILE}" ]] && TOKEN="$(head -n 1 "${TOKENFILE}")"
nordvpn logout --persist-token > /dev/null

if [[ -n ${TOKEN} ]]; then
  # Handle analytics consent prompt for NordVPN 4.0.0+
  echo "n" | nordvpn login --token "${TOKEN}" || {
    echo "Invalid token."
    exit 1
  }
else
  echo "No token set."
  exit 1
fi

exit 0
